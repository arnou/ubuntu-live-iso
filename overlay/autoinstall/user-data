#cloud-config
autoinstall:
  version: 1
  # Empêche Subiquity/Curtin d'essayer de rafraîchir ses snaps lors du démarrage.
  # Dans un environnement sans accès direct au Snap Store (proxy, réseau filtré),
  # cette tentative échoue avec un code de retour 100 et stoppe l'installation.
  refresh-installer:
    updates: false
  locale: fr_FR.UTF-8
  keyboard:
    layout: fr
  timezone: Europe/Paris

  identity:
    hostname: ubuntu-btrfs
    username: utilisateur
    # Mot de passe hashé SHA-512 pour l'utilisateur (exemple: "ubuntu").
    # Remplace-le par ton propre hash (mkpasswd --method=SHA-512 ou openssl passwd -6)
    password: "$6$6r4Do0kI1M$gz7mg5G7KFS9FZ9CfJdReuPhctg5sD4QfdFZsSzA6UOCmBFs4WZEn6Y0dCRQixQY69p6XqVZkqEkb7/ZZvzhq."

  # Stockage : GPT, EFI, /boot non chiffré, racine Btrfs chiffrée (LUKS via keyfile).
  storage:
    layout:
      name: custom
    config:
      # Disque cible (le plus grand par défaut)
      - id: disk0
        type: disk
        match:
          size: largest
        ptable: gpt
        wipe: superblock-recursive

      # Partition EFI (FAT32)
      - id: part-efi
        type: partition
        device: disk0
        size: 550M
        flag: boot

      # Partition /boot non chiffrée (ext4)
      - id: part-boot
        type: partition
        device: disk0
        size: 1G

      # Partition chiffrée (reste du disque)
      - id: part-crypt
        type: partition
        device: disk0
        size: -1

      # LUKS : clé fournie par fichier (accessible via /autoinstall/luks.keyfile)
      - id: luks-root
        type: dm_crypt
        volume: part-crypt
        keyfile: /autoinstall/luks.keyfile
        cipher: aes-xts-plain64
        hash: sha256

      # Système de fichiers Btrfs sur LUKS
      - id: fs-btrfs
        type: format
        volume: luks-root
        fstype: btrfs

      # Sous-volumes Btrfs
      - id: subvol-root
        type: btrfs_subvolume
        volume: fs-btrfs
        name: "@"
      - id: subvol-home
        type: btrfs_subvolume
        volume: fs-btrfs
        name: "@home"
      - id: subvol-var
        type: btrfs_subvolume
        volume: fs-btrfs
        name: "@var"

      # Montages
      - id: mnt-root
        type: mount
        device: subvol-root
        path: /
      - id: mnt-home
        type: mount
        device: subvol-home
        path: /home
      - id: mnt-var
        type: mount
        device: subvol-var
        path: /var

      # /boot (ext4)
      - id: fs-boot
        type: format
        volume: part-boot
        fstype: ext4
      - id: mnt-boot
        type: mount
        device: fs-boot
        path: /boot

      # /boot/efi (FAT32)
      - id: fs-efi
        type: format
        volume: part-efi
        fstype: fat32
      - id: mnt-efi
        type: mount
        device: fs-efi
        path: /boot/efi

  # (Optionnel) Paquets supplémentaires pendant l'installation
  packages:
    - btrfs-progs
    - snapper
    - btrfsmaintenance
    - grub-btrfs

  # Pas de snaps installés par Subiquity
  snaps: []

write_files:
  - path: /usr/local/share/ca-certificates/cnieg-ca.crt
    permissions: '0644'
    content: |
      -----BEGIN CERTIFICATE-----
      MIIGJzCCBQ+gAwIBAgICEAgwDQYJKoZIhvcNAQELBQAwYDELMAkGA1UEBhMCRlIx
      DzANBgNVBAgTBkZSQU5DRTEPMA0GA1UEBxMGTkFOVEVTMQ4wDAYDVQQKEwVDTklF
      RzEMMAoGA1UECxMDRFNJMREwDwYDVQQDEwhDTklFRyBDQTAeFw0xNzAyMDExMDQ3
      MDBaFw0yNzAyMDExMTQ3MDBaME0xCzAJBgNVBAYTAkZSMQ8wDQYDVQQIEwZGUkFO
      Q0UxDzANBgNVBAcTBk5BTlRFUzEOMAwGA1UEChMFQ05JRUcxDDAKBgNVBAsTA0RT
      STCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMHUNzpIPBpUEHlthWzo
      kt6flqlHoPJXgn5WCdN2/mO5s4mr0O6YQ4+R+7NTpu7IBs3QdkgFmikpUW8+wFYW
      V0RKrUtl7vJSlX5D8xoeP8NUEfORt4L3ENwnrEvkK6Icg847HLe2M0PucOsGd+MT
      PdryyfymV8Gdrkhojfd5qhtuAXPcZa9/V2f1EqOxzBSkMxABRNy/W8660SV9QuQ8
      uxPh8ZIB7IOVmsgX4n208kJMgaPI53Fual6WukMUd3MbvmtDFS9SlNTFdCteUDtl
      Crh+r1Ydwb02Naqs1aUb1zy4nd/bPmPCPl/HchiGeOY25ZQ1VZfCDle3KgYiMiqk
      Nn0CAwEAAaOCAvwwggL4MAkGA1UdEwQCMAAwgYsGA1UdIwSBgzCBgIAU4g9kRcRa
      j3MbboIHehueoGH/1RmhZKRiMGAxCzAJBgNVBAYTAkZSMQ8wDQYDVQQIEwZGUkFO
      Q0UxDzANBgNVBAcTBk5BTlRFUzEOMAwGA1UEChMFQ05JRUcxDDAKBgNVBAsTA0RT
      STERMA8GA1UEAxMIQ05JRUcgQ0GCAhAEMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUE
      FjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwggIsBgNVHREEggIjMIICH4IKKi5jbmll
      Zy5mcoIQKi5pZWdwLmVkZmdkZi5mcoIQKi5hbHBoYS5jbmllZy5mcoIQKi5icmF2
      by5jbmllZy5mcoISKi5jaGFybGllLmNuaWVnLmZyghAqLmRlbHRhLmNuaWVnLmZy
      gg8qLmVjaG8uY25pZWcuZnKCEiouZm94dHJvdC5jbmllZy5mcoIPKi5nb2xmLmNu
      aWVnLmZyghAqLmhvdGVsLmNuaWVnLmZyghAqLmluZGlhLmNuaWVnLmZyghEqLmp1
      bGlldC5jbmllZy5mcoISKi5qdWxpZXR0LmNuaWVnLmZygg8qLmtpbG8uY25pZWcu
      ZnKCDyoubGltYS5jbmllZy5mcoIPKi5taWtlLmNuaWVnLmZyghMqLm5vdmVtYmVy
      LmNuaWVnLmZyghAqLm9zY2FyLmNuaWVnLmZygg8qLnBhcGEuY25pZWcuZnKCESou
      cXVlYmVjLmNuaWVnLmZyghAqLnJvbWVvLmNuaWVnLmZyghEqLnNpZXJyYS5jbmll
      Zy5mcoIQKi50YW5nby5jbmllZy5mcoISKi51bmlmb3JtLmNuaWVnLmZyghEqLnZp
      Y3Rvci5jbmllZy5mcoIRKi53aGlza3kuY25pZWcuZnKCECoueC1yYXkuY25pZWcu
      ZnKCDyoueHJheS5jbmllZy5mcoIRKi55YW5rZWUuY25pZWcuZnKCDyouenVsdS5j
      bmllZy5mcjANBgkqhkiG9w0BAQsFAAOCAQEAH9g7HpSnGg9vKvReCm4XYrJylKPL
      xI4iU/+nkiQCBapns+zjbBj/NzA53FUyK9LWcN/IpPTGLN453PxRlLrRmEibR71a
      isc96Z7QASri3oOIQMuhzYtv+kvNLJMDaQqCVOmgYxeBgckhF7dgebP4VbWPJccE
      sf0xKH0bjUCsZkSByOILGXCjNdwjYjfiWMyk14xkDl7GOIskTKGQe7t2t506mH1K
      7IlfksnoTIL6jHePFMRR9i6ox7BZtR7x1OOO7ErqFLMJuLajtJYSVSNTLOjLuQ4B
      SWIhYR+9aq5TbOyAWF0WIg+FqRYjUc6qFIpaRk/1HPZGTZt2P5snJmwHLA==
      -----END CERTIFICATE-----
      -----BEGIN CERTIFICATE-----
      MIIDfjCCAmagAwIBAgICEAQwDQYJKoZIhvcNAQELBQAwYDELMAkGA1UEBhMCRlIx
      DzANBgNVBAgTBkZSQU5DRTEPMA0GA1UEBxMGTkFOVEVTMQ4wDAYDVQQKEwVDTklF
      RzEMMAoGA1UECxMDRFNJMREwDwYDVQQDEwhDTklFRyBDQTAeFw0xNTEwMTkxMjM3
      MThaFw00NTEwMTkxNDM3MThaMGAxCzAJBgNVBAYTAkZSMQ8wDQYDVQQIEwZGUkFO
      Q0UxDzANBgNVBAcTBk5BTlRFUzEOMAwGA1UEChMFQ05JRUcxDDAKBgNVBAsTA0RT
      STERMA8GA1UEAxMIQ05JRUcgQ0EwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
      AoIBAQDKSshZrM64BiQCPVSx5KDQNAVp0CpyK+64+6HOS0BWBpo9nxTmKel2TOPM
      RiXq+kX2egIYIf/Y0kOxL9OZji9NxmN9lEc29w1aybcVi0P8xYuNoFsfq6K9lTct
      Co41g16qWZqC2gaVBWwo3VlWWAh7sBtKshLS4pbmNw6RFGYYU9kphVNLqMzYGXX8
      Z0v/AghV47SnS6gjnSXlTZfN6AqkySZv6DUDoVK4Un51qSSPdkwoBfklp8DNFO6y
      GMbdV86bd8MgQy4X1bM1oTpjvIk3ZkWE4lONmyS8gGp86vcIcHz/acztjF9Sn6gP
      T66PaS7aISA0W45ilDitG4aMDOhfAgMBAAGjQjBAMA8GA1UdEwEB/wQFMAMBAf8w
      DgYDVR0PAQH/BAQDAgEGMB0GA1UdDgQWBBTiD2RFxFqPcxtuggd6G56gYf/VGTAN
      BgkqhkiG9w0BAQsFAAOCAQEAIPCG16eA9zG0YqLe/hQAoyxWZ0XyePKj8Yx3SOpz
      MAKSPCCmLzcfzZ3TdJnJqGTjpQxS38FPLoUKPxMZODdlU2V3T34qxWTjbbi8jPPB
      0XT4KIG3JHjGah7Ut1QRX04tDhDuiz5p+bTdmAkMJpJYLZ41XGQO2WRWqKc6X5QP
      /ez2vnXQGAZbP/ewHHxYiVJ1OxCciFhs0eYyFylZHYXUv7oebx1st3ByqQwfoEqX
      sg4scJM3jsL8shiawYZfOwRbvoMBnX6rlua/v2Zogv6W0TP4LQXZVwawpDIZvXkU
      1xvD4KGo2ZmDW+KlxVRUlPkdqsSiH1n006ouX+Vn7HkCCw==
      -----END CERTIFICATE-----

runcmd:
  - update-ca-certificates

